/-
Copyright (c) 2026 Cameron Freer. All rights reserved.
Released under Apache 2.0 license as described in the file LICENSE.
Authors: Cameron Freer
-/
import Mathlib.MeasureTheory.Constructions.Pi
import Mathlib.MeasureTheory.PiSystem
import Mathlib.Probability.Kernel.Basic

/-!
# Measurability of Product Measure Kernels

This file contains technical lemmas about measurability of product measure kernels.
These lemmas support de Finetti-type theorems but are general-purpose results about
measure theory on product spaces.

## Main Results

* `measurable_prod_ennreal`: Products of measurable ENNReal functions are measurable
* `rectangles_isPiSystem`: Measurable rectangles form a Ï€-system
* `rectangles_generate_pi_sigma`: Product Ïƒ-algebra = generateFrom of rectangles
* `measurable_measure_pi`: Measurability of product measure kernels Ï‰ â†¦ âˆáµ¢ Î½ Ï‰

## Mathematical Context

The key technique is Ï€-system induction: proving measurability on rectangles (a Ï€-system)
and extending to all measurable sets via the Ï€-Î» theorem.

## Suggested Mathlib Location

`Mathlib.Probability.Kernel.Measurable` or `Mathlib.MeasureTheory.Constructions.Pi`

## References

* Kallenberg (2005), *Probabilistic Symmetries and Invariance Principles*
-/

noncomputable section
open scoped BigOperators MeasureTheory
open MeasureTheory ProbabilityTheory Set

variable {Î© Î± : Type*} [MeasurableSpace Î©] [MeasurableSpace Î±]

/-! ### Preliminary lemmas -/

/-- The product of finitely many measurable ENNReal-valued functions is measurable.

This is a wrapper around `Finset.measurable_prod` specialized to ENNReal. -/
lemma measurable_prod_ennreal {Î¹ : Type*} [Fintype Î¹] {Î© : Type*} [MeasurableSpace Î©]
    (f : Î¹ â†’ Î© â†’ ENNReal) (hf : âˆ€ i, Measurable (f i)) :
    Measurable fun Ï‰ => âˆ i, f i Ï‰ :=
  Finset.measurable_prod _ fun i _ => hf i

/-- Rewrite `Set.univ.pi B` as a setOf comprehension. -/
lemma univ_pi_eq_setOf_forall {Î¹ : Type*} {Î± : Type*} (B : Î¹ â†’ Set Î±) :
    Set.univ.pi B = {x | âˆ€ i, x i âˆˆ B i} := by
  ext x; simp [Set.pi]

/-! ### Ï€-system structure of rectangles -/

/-- Measurable rectangles form a Ï€-system for the product Ïƒ-algebra.

A rectangle in (Fin m â†’ Î±) is a set of the form {x | âˆ€ i, x i âˆˆ B i} where each B i
is measurable. The collection of such rectangles is closed under finite intersections. -/
lemma rectangles_isPiSystem {m : â„•} {Î± : Type*} [MeasurableSpace Î±] :
    IsPiSystem {S : Set (Fin m â†’ Î±) | âˆƒ (B : Fin m â†’ Set Î±),
      (âˆ€ i, MeasurableSet (B i)) âˆ§ S = {x | âˆ€ i, x i âˆˆ B i}} := by
  intro Sâ‚ hSâ‚ Sâ‚‚ hSâ‚‚ _hne
  obtain âŸ¨Bâ‚, hBâ‚_meas, rflâŸ© := hSâ‚
  obtain âŸ¨Bâ‚‚, hBâ‚‚_meas, rflâŸ© := hSâ‚‚
  use fun i => Bâ‚ i âˆ© Bâ‚‚ i
  constructor
  Â· exact fun i => (hBâ‚_meas i).inter (hBâ‚‚_meas i)
  Â· ext x
    simp only [Set.mem_inter_iff, Set.mem_setOf_eq]
    exact âŸ¨fun âŸ¨hâ‚, hâ‚‚âŸ© i => âŸ¨hâ‚ i, hâ‚‚ iâŸ©, fun h => âŸ¨fun i => (h i).1, fun i => (h i).2âŸ©âŸ©

/-- The product Ïƒ-algebra on (Fin m â†’ Î±) is generated by measurable rectangles.

This is a fundamental result in product measure theory: the Ïƒ-algebra on a finite
product equals the Ïƒ-algebra generated by measurable rectangles. -/
lemma rectangles_generate_pi_sigma {m : â„•} {Î± : Type*} [MeasurableSpace Î±] :
    (inferInstance : MeasurableSpace (Fin m â†’ Î±)) =
    MeasurableSpace.generateFrom {S : Set (Fin m â†’ Î±) | âˆƒ (B : Fin m â†’ Set Î±),
      (âˆ€ i, MeasurableSet (B i)) âˆ§ S = {x | âˆ€ i, x i âˆˆ B i}} := by
  have set_eq : {S : Set (Fin m â†’ Î±) | âˆƒ (B : Fin m â†’ Set Î±),
      (âˆ€ i, MeasurableSet (B i)) âˆ§ S = {x | âˆ€ i, x i âˆˆ B i}} =
      Set.pi univ '' Set.pi univ fun i : Fin m => {s : Set Î± | MeasurableSet s} := by
    ext S
    constructor
    Â· intro âŸ¨B, hB_meas, hSâŸ©
      use fun i => B i
      simp only [Set.mem_pi]
      exact âŸ¨fun i _ => hB_meas i, by rw [univ_pi_eq_setOf_forall]; exact hS.symmâŸ©
    Â· intro âŸ¨B, hB_mem, hSâŸ©
      simp only [Set.mem_pi, Set.mem_univ, Set.mem_setOf_eq] at hB_mem hS
      use B
      exact âŸ¨fun i => hB_mem i (Set.mem_univ i), by rw [â† univ_pi_eq_setOf_forall]; exact hS.symmâŸ©
  rw [set_eq]
  exact generateFrom_pi.symm

/-! ### Measurability of product measure kernels -/

/-- The product measure kernel Ï‰ â†¦ Measure.pi (fun _ => Î½ Ï‰) is measurable.

Given a measurable family of probability measures Î½ : Î© â†’ Measure Î±, the product
kernel Ï‰ â†¦ âˆáµ¢ Î½ Ï‰ (where i ranges over Fin m) is measurable as a measure-valued map.

**Proof strategy**: Use Ï€-system induction on rectangles:
1. Rectangles generate the product Ïƒ-algebra (`rectangles_generate_pi_sigma`)
2. Rectangles form a Ï€-system (`rectangles_isPiSystem`)
3. On rectangles, the product measure of {x | âˆ€ i, x i âˆˆ B i} equals âˆáµ¢ Î½ Ï‰ (B i),
   which is measurable in Ï‰ by `measurable_prod_ennreal`
4. By the Ï€-Î» theorem, measurability on the generating Ï€-system extends to all measurable sets

This is a key lemma for proving the ConditionallyIID property in de Finetti's theorem. -/
lemma measurable_measure_pi {Î© Î± : Type*} [MeasurableSpace Î©] [MeasurableSpace Î±]
    {m : â„•}
    (Î½ : Î© â†’ Measure Î±) (hÎ½_prob : âˆ€ Ï‰, IsProbabilityMeasure (Î½ Ï‰))
    (hÎ½_meas : âˆ€ s, MeasurableSet s â†’ Measurable (fun Ï‰ => Î½ Ï‰ s)) :
    Measurable fun Ï‰ => Measure.pi fun _ : Fin m => Î½ Ï‰ := by
  classical
  let Îº : Î© â†’ Measure (Fin m â†’ Î±) := fun Ï‰ => Measure.pi fun _ : Fin m => Î½ Ï‰
  let ð’ž : Set (Set (Fin m â†’ Î±)) :=
    {S | âˆƒ (B : Fin m â†’ Set Î±), (âˆ€ i, MeasurableSet (B i)) âˆ§ S = {x | âˆ€ i, x i âˆˆ B i}}

  have h_gen : (inferInstance : MeasurableSpace (Fin m â†’ Î±)) = MeasurableSpace.generateFrom ð’ž :=
    rectangles_generate_pi_sigma (m := m) (Î± := Î±)
  have h_pi : IsPiSystem ð’ž := rectangles_isPiSystem (m := m) (Î± := Î±)

  -- Values on rectangles are measurable
  have h_basic : âˆ€ t âˆˆ ð’ž, Measurable fun Ï‰ => Îº Ï‰ t := by
    intro t ht
    rcases ht with âŸ¨B, hB, rflâŸ©
    have rect : (fun Ï‰ => Îº Ï‰ {x : Fin m â†’ Î± | âˆ€ i, x i âˆˆ B i}) = fun Ï‰ => âˆ i : Fin m, Î½ Ï‰ (B i) :=
      by funext Ï‰
         have : {x : Fin m â†’ Î± | âˆ€ i, x i âˆˆ B i} = Set.univ.pi B := by ext; simp [Set.pi]
         simp only [Îº, this, Measure.pi_pi]
    have hmeas : Measurable fun Ï‰ => âˆ i : Fin m, Î½ Ï‰ (B i) :=
      measurable_prod_ennreal (fun i Ï‰ => Î½ Ï‰ (B i)) (fun i => hÎ½_meas (B i) (hB i))
    simpa [Îº, rect]

  -- Each product measure is a probability measure
  haveI hÎº_prob : âˆ€ Ï‰, IsProbabilityMeasure (Îº Ï‰) := by
    intro Ï‰
    haveI : âˆ€ i : Fin m, IsProbabilityMeasure (Î½ Ï‰) := fun _ => hÎ½_prob Ï‰
    infer_instance

  -- Apply Ï€-Î» theorem
  exact Measurable.measure_of_isPiSystem_of_isProbabilityMeasure h_gen h_pi h_basic

