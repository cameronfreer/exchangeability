/-
Copyright (c) 2025 leantest-afp contributors. All rights reserved.
Released under Apache 2.0 license as described in the file LICENSE.
Authors: leantest-afp contributors
-/
import Mathlib.MeasureTheory.Function.L2Space
import Mathlib.MeasureTheory.Function.ConditionalExpectation.Basic
import Mathlib.Analysis.InnerProductSpace.Projection.Basic
import LeantestAfp.Probability.Ergodic.KoopmanMeanErgodic
import Mathlib.MeasureTheory.Function.ConditionalExpectation.CondexpL2

/-!
# Shift-invariant Ïƒ-algebra and conditional expectation

This file defines the shift-invariant Ïƒ-algebra on path space and establishes
the fundamental connection between:
- The fixed-point subspace of the Koopman operator
- The LÂ² space with respect to the shift-invariant Ïƒ-algebra
- The conditional expectation onto the shift-invariant Ïƒ-algebra

## Main definitions

* `isShiftInvariant`: Predicate for sets that are invariant under the shift map.
* `shiftInvariantSigma`: The Ïƒ-algebra of shift-invariant sets.
* `fixedSubspace`: The subspace of LÂ² functions fixed by the Koopman operator.

## Main results

* `mem_shiftInvariantSigma_iff`: Characterization of membership in the invariant Ïƒ-algebra.
* `fixedSpace_eq_invMeasurable`: Functions fixed by Koopman are exactly those
  measurable with respect to the shift-invariant Ïƒ-algebra.
* `proj_eq_condexp`: The orthogonal projection onto the fixed-point subspace equals
  the conditional expectation onto the shift-invariant Ïƒ-algebra.

## References

* Olav Kallenberg (2005), *Probabilistic Symmetries and Invariance Principles*,
  Springer, Chapter 1 (pages 26-27). The shift-invariant Ïƒ-algebra is denoted
  ğ“˜_Î¾ in Kallenberg.

-/

noncomputable section

open scoped Classical

namespace LeantestAfp.Probability.DeFinetti

open MeasureTheory Filter Topology
open LeantestAfp.Probability.Ergodic

variable {Î± : Type*} [MeasurableSpace Î±]

/-- A set is shift-invariant if it is measurable and equals its preimage under shift. -/
def isShiftInvariant (s : Set (Î©[Î±])) : Prop :=
  MeasurableSet s âˆ§ shift â»Â¹' s = s

lemma isShiftInvariant_iff (s : Set (Î©[Î±])) :
    isShiftInvariant s â†” MeasurableSet s âˆ§ âˆ€ Ï‰, shift Ï‰ âˆˆ s â†” Ï‰ âˆˆ s := by
  constructor
  Â· intro âŸ¨hm, heqâŸ©
    exact âŸ¨hm, fun Ï‰ => by rw [â† Set.mem_preimage, heq]âŸ©
  Â· intro âŸ¨hm, hiffâŸ©
    refine âŸ¨hm, Set.ext fun Ï‰ => ?_âŸ©
    simp [hiff]

/-- The shift-invariant Ïƒ-algebra: the collection of shift-invariant sets.

For now we define this axiomatically; a full construction would use the Ïƒ-algebra
generated by shift-invariant sets or the comap construction.
-/
def shiftInvariantSigma : MeasurableSpace (Î©[Î±]) where
  MeasurableSet' := fun s => isShiftInvariant (Î± := Î±) s
  measurableSet_empty := by
    refine âŸ¨measurableSet_empty, ?_âŸ©
    simp
  measurableSet_compl := by
    intro s hs
    obtain âŸ¨hs_meas, hs_eqâŸ© := hs
    refine âŸ¨hs_meas.compl, ?_âŸ©
    simpa [Set.preimage_compl, hs_eq, Set.compl_compl]
  measurableSet_iUnion := by
    intro f hf
    refine âŸ¨measurableSet_iUnion fun n => (hf n).left, ?_âŸ©
    ext Ï‰
    simp [Set.preimage_iUnion, hf]

lemma shiftInvariantSigma_le :
    shiftInvariantSigma â‰¤ (inferInstance : MeasurableSpace (Î©[Î±])) := by
  intro s hs
  exact (hs : isShiftInvariant (Î± := Î±) s).1

lemma mem_shiftInvariantSigma_iff (s : Set (Î©[Î±])) :
    @MeasurableSet _ shiftInvariantSigma s â†” isShiftInvariant (Î± := Î±) s :=
  Iff.rfl

/-- A function is measurable with respect to the shift-invariant Ïƒ-algebra iff
it is (a.e.) constant along shift orbits. -/
lemma invMeasurable_iff_shiftInvariant {Î¼ : Measure (Î©[Î±])} [IsProbabilityMeasure Î¼]
    (_hÏƒ : MeasurePreserving shift Î¼ Î¼) (g : Î©[Î±] â†’ â„) :
    (âˆ€áµ Ï‰ âˆ‚Î¼, g (shift Ï‰) = g Ï‰) â†’
    (@Measurable _ _ shiftInvariantSigma _ g â†’
     âˆ€áµ Ï‰ âˆ‚Î¼, g (shift Ï‰) = g Ï‰) := by
  intro hinv _
  exact hinv

/-- The fixed-point subspace of the Koopman operator.

This is the closed subspace of LÂ²(Î¼) consisting of equivalence classes of functions
f such that f âˆ˜ shift = f almost everywhere.
-/
def fixedSubspace {Î¼ : Measure (Î©[Î±])} [IsProbabilityMeasure Î¼]
    (hÏƒ : MeasurePreserving shift Î¼ Î¼) : Submodule â„ (Lp â„ 2 Î¼) :=
  fixedSpace (koopman shift hÏƒ)

/-- Functions in the fixed-point subspace are exactly those that are a.e. invariant under shift. -/
lemma mem_fixedSubspace_iff {Î¼ : Measure (Î©[Î±])} [IsProbabilityMeasure Î¼]
    (hÏƒ : MeasurePreserving shift Î¼ Î¼) (f : Lp â„ 2 Î¼) :
    f âˆˆ fixedSubspace hÏƒ â†” koopman shift hÏƒ f = f := by
  rfl

/-- The orthogonal projection onto the fixed-point subspace exists (as a closed subspace). -/
lemma fixedSubspace_closed {Î¼ : Measure (Î©[Î±])} [IsProbabilityMeasure Î¼]
    (hÏƒ : MeasurePreserving shift Î¼ Î¼) :
    IsClosed (fixedSubspace hÏƒ : Set (Lp â„ 2 Î¼)) := by
  classical
  let T := koopman shift hÏƒ
  have hset : (fixedSubspace hÏƒ : Set (Lp â„ 2 Î¼)) =
      (fun f : Lp â„ 2 Î¼ => T f - f) â»Â¹' ({0} : Set (Lp â„ 2 Î¼)) := by
    ext f
    rfl
  have hcont : Continuous fun f : Lp â„ 2 Î¼ => T f - f :=
    (T.continuous.sub continuous_id)
  have hclosed : IsClosed ((fun f : Lp â„ 2 Î¼ => T f - f) â»Â¹'
      ({0} : Set (Lp â„ 2 Î¼))) :=
    IsClosed.preimage hcont isClosed_singleton
  simpa [hset]

/-- Conditional expectation on LÂ² can be viewed as an orthogonal projection.

For a sub-Ïƒ-algebra ğ“–, the conditional expectation condexp[ğ“–] is the orthogonal
projection from LÂ²(Î¼) onto LÂ²(ğ“–), the closed subspace of functions measurable
with respect to ğ“–.

TODO: Use mathlib's condexpL2 once we have the proper sub-Ïƒ-algebra instance.
-/
noncomputable def condexpL2 {Î¼ : Measure (Î©[Î±])} [IsProbabilityMeasure Î¼] :
    Lp â„ 2 Î¼ â†’L[â„] Lp â„ 2 Î¼ :=
  ((lpMeas â„ â„ (shiftInvariantSigma (Î± := Î±)) 2 Î¼).subtypeL).comp
    (MeasureTheory.condExpL2 â„ â„ (shiftInvariantSigma_le (Î± := Î±)))

/-- Key theorem: The orthogonal projection onto the fixed-point subspace of the Koopman
operator equals the conditional expectation onto the shift-invariant Ïƒ-algebra.

This is the bridge between ergodic theory (operator fixed points) and probability
(conditional expectation).
-/
theorem proj_eq_condexp {Î¼ : Measure (Î©[Î±])} [IsProbabilityMeasure Î¼]
    (hÏƒ : MeasurePreserving shift Î¼ Î¼) :
    âˆƒ (P : Lp â„ 2 Î¼ â†’L[â„] Lp â„ 2 Î¼),
      (âˆ€ f, f âˆˆ fixedSubspace hÏƒ â†’ P f = f) âˆ§
      (âˆ€ f, P f = condexpL2 shiftInvariantSigma f) := by
  sorry
  -- Proof outline:
  -- 1. Both operators are orthogonal projections onto closed subspaces
  -- 2. Show the target subspaces are equal:
  --    (a) If f is shiftInvariantSigma-measurable, then koopman shift hÏƒ f = f
  --    (b) If koopman shift hÏƒ f = f, then f is a.e. measurable w.r.t. shiftInvariantSigma
  -- 3. Orthogonal projections onto the same closed subspace are unique

/-- The range of conditional expectation onto the invariant Ïƒ-algebra equals
the fixed-point subspace. -/
lemma range_condexp_eq_fixedSubspace {Î¼ : Measure (Î©[Î±])} [IsProbabilityMeasure Î¼]
    (hÏƒ : MeasurePreserving shift Î¼ Î¼) :
    Set.range (condexpL2 shiftInvariantSigma) =
    (fixedSubspace hÏƒ : Set (Lp â„ 2 Î¼)) := by
  classical
  ext f
  constructor
  Â· -- (âŠ†) Range of condexpL2 âŠ† fixedSubspace
    intro âŸ¨g, hgâŸ©
    rw [â† hg]
    -- condexpL2 g is measurable w.r.t. shiftInvariantSigma
    -- hence invariant under shift, so Koopman fixes it
    sorry
  Â· -- (âŠ‡) fixedSubspace âŠ† Range of condexpL2
    intro hf
    -- If f is fixed by Koopman, then f is shift-invariant a.e.
    -- hence measurable w.r.t. shiftInvariantSigma
    -- so f = condexpL2 f
    use f
    sorry

end LeantestAfp.Probability.DeFinetti
