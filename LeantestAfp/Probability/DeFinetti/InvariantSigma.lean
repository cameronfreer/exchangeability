/-
Copyright (c) 2025 leantest-afp contributors. All rights reserved.
Released under Apache 2.0 license as described in the file LICENSE.
Authors: leantest-afp contributors
-/
import Mathlib.MeasureTheory.Function.L2Space
import Mathlib.MeasureTheory.Function.ConditionalExpectation.Basic
import Mathlib.Analysis.InnerProductSpace.Projection.Basic
import LeantestAfp.Probability.Ergodic.KoopmanMeanErgodic
import Mathlib.MeasureTheory.Function.ConditionalExpectation.CondexpL2

/-!
# Shift-invariant œÉ-algebra and conditional expectation

This file defines the shift-invariant œÉ-algebra on path space and establishes
the fundamental connection between:
- The fixed-point subspace of the Koopman operator
- The L¬≤ space with respect to the shift-invariant œÉ-algebra
- The conditional expectation onto the shift-invariant œÉ-algebra

## Main definitions

* `isShiftInvariant`: Predicate for sets that are invariant under the shift map.
* `shiftInvariantSigma`: The œÉ-algebra of shift-invariant sets.
* `fixedSubspace`: The subspace of L¬≤ functions fixed by the Koopman operator.

## Main results

* `mem_shiftInvariantSigma_iff`: Characterization of membership in the invariant œÉ-algebra.
* `fixedSpace_eq_invMeasurable`: Functions fixed by Koopman are exactly those
  measurable with respect to the shift-invariant œÉ-algebra.
* `proj_eq_condexp`: The orthogonal projection onto the fixed-point subspace equals
  the conditional expectation onto the shift-invariant œÉ-algebra.

## References

* Olav Kallenberg (2005), *Probabilistic Symmetries and Invariance Principles*,
  Springer, Chapter 1 (pages 26-27). The shift-invariant œÉ-algebra is denoted
  ùìò_Œæ in Kallenberg.

-/

noncomputable section

open scoped Classical

namespace LeantestAfp.Probability.DeFinetti

open MeasureTheory Filter Topology
open LeantestAfp.Probability.Ergodic

variable {Œ± : Type*} [MeasurableSpace Œ±]

/-- A set is shift-invariant if it is measurable and equals its preimage under shift. -/
def isShiftInvariant (s : Set (Œ©[Œ±])) : Prop :=
  MeasurableSet s ‚àß shift ‚Åª¬π' s = s

lemma isShiftInvariant_iff (s : Set (Œ©[Œ±])) :
    isShiftInvariant s ‚Üî MeasurableSet s ‚àß ‚àÄ œâ, shift œâ ‚àà s ‚Üî œâ ‚àà s := by
  constructor
  ¬∑ intro ‚ü®hm, heq‚ü©
    exact ‚ü®hm, fun œâ => by rw [‚Üê Set.mem_preimage, heq]‚ü©
  ¬∑ intro ‚ü®hm, hiff‚ü©
    refine ‚ü®hm, Set.ext fun œâ => ?_‚ü©
    simp [hiff]

/-- The shift-invariant œÉ-algebra: the collection of shift-invariant sets.

For now we define this axiomatically; a full construction would use the œÉ-algebra
generated by shift-invariant sets or the comap construction.
-/
def shiftInvariantSigma : MeasurableSpace (Œ©[Œ±]) where
  MeasurableSet' := fun s => isShiftInvariant (Œ± := Œ±) s
  measurableSet_empty := by
    refine ‚ü®measurableSet_empty, ?_‚ü©
    simp
  measurableSet_compl := by
    intro s hs
    obtain ‚ü®hs_meas, hs_eq‚ü© := hs
    refine ‚ü®hs_meas.compl, ?_‚ü©
    simpa [Set.preimage_compl, hs_eq, Set.compl_compl]
  measurableSet_iUnion := by
    intro f hf
    refine ‚ü®measurableSet_iUnion fun n => (hf n).left, ?_‚ü©
    ext œâ
    simp [Set.preimage_iUnion, hf]

lemma shiftInvariantSigma_le :
    shiftInvariantSigma ‚â§ (inferInstance : MeasurableSpace (Œ©[Œ±])) := by
  intro s hs
  exact (hs : isShiftInvariant (Œ± := Œ±) s).1

lemma mem_shiftInvariantSigma_iff (s : Set (Œ©[Œ±])) :
    @MeasurableSet _ shiftInvariantSigma s ‚Üî isShiftInvariant (Œ± := Œ±) s :=
  Iff.rfl

/-- A function is measurable with respect to the shift-invariant œÉ-algebra iff
it is (a.e.) constant along shift orbits. -/
lemma invMeasurable_iff_shiftInvariant {Œº : Measure (Œ©[Œ±])} [IsProbabilityMeasure Œº]
    (_hœÉ : MeasurePreserving shift Œº Œº) (g : Œ©[Œ±] ‚Üí ‚Ñù) :
    (‚àÄ·µê œâ ‚àÇŒº, g (shift œâ) = g œâ) ‚Üí
    (@Measurable _ _ shiftInvariantSigma _ g ‚Üí
     ‚àÄ·µê œâ ‚àÇŒº, g (shift œâ) = g œâ) := by
  intro hinv _
  exact hinv

/-- The fixed-point subspace of the Koopman operator.

This is the closed subspace of L¬≤(Œº) consisting of equivalence classes of functions
f such that f ‚àò shift = f almost everywhere.
-/
def fixedSubspace {Œº : Measure (Œ©[Œ±])} [IsProbabilityMeasure Œº]
    (hœÉ : MeasurePreserving shift Œº Œº) : Submodule ‚Ñù (Lp ‚Ñù 2 Œº) :=
  fixedSpace (koopman shift hœÉ)

/-- Functions in the fixed-point subspace are exactly those that are a.e. invariant under shift. -/
lemma mem_fixedSubspace_iff {Œº : Measure (Œ©[Œ±])} [IsProbabilityMeasure Œº]
    (hœÉ : MeasurePreserving shift Œº Œº) (f : Lp ‚Ñù 2 Œº) :
    f ‚àà fixedSubspace hœÉ ‚Üî koopman shift hœÉ f = f := by
  rfl

/-- The orthogonal projection onto the fixed-point subspace exists (as a closed subspace). -/
lemma fixedSubspace_closed {Œº : Measure (Œ©[Œ±])} [IsProbabilityMeasure Œº]
    (hœÉ : MeasurePreserving shift Œº Œº) :
    IsClosed (fixedSubspace hœÉ : Set (Lp ‚Ñù 2 Œº)) := by
  classical
  let T := koopman shift hœÉ
  have hset : (fixedSubspace hœÉ : Set (Lp ‚Ñù 2 Œº)) =
      (fun f : Lp ‚Ñù 2 Œº => T f - f) ‚Åª¬π' ({0} : Set (Lp ‚Ñù 2 Œº)) := by
    ext f
    rfl
  have hcont : Continuous fun f : Lp ‚Ñù 2 Œº => T f - f :=
    (T.continuous.sub continuous_id)
  have hclosed : IsClosed ((fun f : Lp ‚Ñù 2 Œº => T f - f) ‚Åª¬π'
      ({0} : Set (Lp ‚Ñù 2 Œº))) :=
    IsClosed.preimage hcont isClosed_singleton
  simpa [hset]

/-- Conditional expectation on L¬≤ can be viewed as an orthogonal projection.

For a sub-œÉ-algebra ùìñ, the conditional expectation condexp[ùìñ] is the orthogonal
projection from L¬≤(Œº) onto L¬≤(ùìñ), the closed subspace of functions measurable
with respect to ùìñ.

TODO: Use mathlib's condexpL2 once we have the proper sub-œÉ-algebra instance.
-/
noncomputable def condexpL2 {Œº : Measure (Œ©[Œ±])} [IsProbabilityMeasure Œº] :
    Lp ‚Ñù 2 Œº ‚ÜíL[‚Ñù] Lp ‚Ñù 2 Œº :=
  ((lpMeas ‚Ñù ‚Ñù (shiftInvariantSigma (Œ± := Œ±)) 2 Œº).subtypeL).comp
    (MeasureTheory.condExpL2 ‚Ñù ‚Ñù (shiftInvariantSigma_le (Œ± := Œ±)))

/-- Key theorem: The orthogonal projection onto the fixed-point subspace of the Koopman
operator equals the conditional expectation onto the shift-invariant œÉ-algebra.

This is the bridge between ergodic theory (operator fixed points) and probability
(conditional expectation).
-/
theorem proj_eq_condexp {Œº : Measure (Œ©[Œ±])} [IsProbabilityMeasure Œº]
    (hœÉ : MeasurePreserving shift Œº Œº) :
    ‚àÉ (P : Lp ‚Ñù 2 Œº ‚ÜíL[‚Ñù] Lp ‚Ñù 2 Œº),
      (‚àÄ f, f ‚àà fixedSubspace hœÉ ‚Üí P f = f) ‚àß
      (‚àÄ f, P f = condexpL2 shiftInvariantSigma f) := by
  /-
  Sketch of proof:
  1. Let `P‚ÇÄ := (lpMeas ‚Ä¶).orthogonalProjection`. Observe that our definition of `condexpL2`
     is `subtypeL.comp P‚ÇÄ`, so showing `P‚ÇÄ` equals the orthogonal projection onto
     `fixedSubspace hœÉ` is enough.
  2. Build the equivalence of subspaces.
     * (Forward) If `g` is `shiftInvariantSigma`-measurable, then `g ‚àò shift = g` a.e.
       Produce a lemma
         `lemma shiftInvariantSigma_measurable_aestronglyMeasurable
             (hg : AEStronglyMeasurable[m] g Œº) : g ‚àò shift =·µê Œº g`.
       This will use that measurable sets in `shiftInvariantSigma` are invariant by the
       definition of the œÉ-algebra, together with the fact that evaluation maps on `Œ©[Œ±]`
       generate the œÉ-algebra.
     * (Reverse) If `koopman shift hœÉ f = f`, then `f` is invariant a.e.  Use the
       representatives lemma for `Lp` to get an a.e. equal function `g`. Show that `g` is
       measurable w.r.t. `shiftInvariantSigma` by proving that its level sets belong to
       the invariant œÉ-algebra.  A convenient way is to start with simple functions,
       use stability of the invariant œÉ-algebra under limits, and appeal to the
       dominated convergence theorem.
  3. Once the two closed subspaces agree, uniqueness of orthogonal projections yields the
     desired statement (cf. `Submodule.orthogonalProjection_eq_self_of_subset`).
  4. Finally, wrap up: choose `P := condexpL2 shiftInvariantSigma` and show it satisfies the
     two characterising properties using the two inclusions from step 2.
  -/
  sorry

/-- The range of conditional expectation onto the invariant œÉ-algebra equals
the fixed-point subspace. -/
lemma range_condexp_eq_fixedSubspace {Œº : Measure (Œ©[Œ±])} [IsProbabilityMeasure Œº]
    (hœÉ : MeasurePreserving shift Œº Œº) :
    Set.range (condexpL2 shiftInvariantSigma) =
    (fixedSubspace hœÉ : Set (Lp ‚Ñù 2 Œº)) := by
  classical
  ext f
  constructor
  ¬∑ -- (‚äÜ) Range of condexpL2 ‚äÜ fixedSubspace
    intro ‚ü®g, hg‚ü©
    rw [‚Üê hg]
    -- condexpL2 g is measurable w.r.t. shiftInvariantSigma
    -- hence invariant under shift, so Koopman fixes it
    /-
    Outline:
    1. Apply the measurability statement from the sketch above to conclude that
       `condexpL2 shiftInvariantSigma g` has a representative that is
       `shiftInvariantSigma`-measurable.
    2. Invoke the forward inclusion lemma to deduce Koopman invariance, and then
       restate it as membership in `fixedSubspace hœÉ` via `mem_fixedSubspace_iff`.
    -/
    sorry
  ¬∑ -- (‚äá) fixedSubspace ‚äÜ Range of condexpL2
    intro hf
    -- If f is fixed by Koopman, then f is shift-invariant a.e.
    -- hence measurable w.r.t. shiftInvariantSigma
    -- so f = condexpL2 f
    use f
    /-
    Outline:
    1. Starting from `hf : f ‚àà fixedSubspace hœÉ`, use `mem_fixedSubspace_iff` to get the
       almost everywhere invariance of `f` under `shift`.
    2. Produce a representative that is strictly invariant on a Œº-a.e. invariant set,
       then prove it is `shiftInvariantSigma`-measurable (reverse inclusion lemma).
    3. Invoke the defining property of conditional expectation on `Lp` to conclude that
       `condexpL2 shiftInvariantSigma f = f`.
    -/
    sorry

end LeantestAfp.Probability.DeFinetti
