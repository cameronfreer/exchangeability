/-
Copyright (c) 2025 Cameron Freer. All rights reserved.
Released under Apache 2.0 license as described in the file LICENSE.
Authors: Cameron Freer
-/
import Mathlib.MeasureTheory.Constructions.Pi
import Mathlib.MeasureTheory.PiSystem
import Mathlib.Probability.Kernel.Basic

/-!
# Measurability of Product Measure Kernels

This file contains technical lemmas about measurability of product measure kernels.
These lemmas support the de Finetti theorem proof machinery but are general-purpose
results about measure theory on product spaces.

## Main results

* `measurable_prod_ennreal`: Products of measurable ENNReal functions are measurable
* `rectangles_isPiSystem`: Measurable rectangles form a Ï€-system
* `rectangles_generate_pi_sigma`: The product Ïƒ-algebra equals the Ïƒ-algebra generated by rectangles
* `measurable_measure_pi`: Measurability of product measure kernels Ï‰ â†¦ âˆáµ¢ Î½ Ï‰
* `aemeasurable_measure_pi`: AE-measurability version (implies measurable version)

## Implementation notes

These lemmas were extracted from `CommonEnding.lean` to break circular dependencies
between `ConditionallyIID.lean` and `CommonEnding.lean`.

The key technique is Ï€-system induction: proving measurability on rectangles (a Ï€-system)
and extending to all measurable sets via the Ï€-Î» theorem.

## References

* Kallenberg (2005), *Probabilistic Symmetries and Invariance Principles*
-/

noncomputable section
open scoped BigOperators MeasureTheory
open MeasureTheory ProbabilityTheory Set

variable {Î© Î± : Type*} [MeasurableSpace Î©] [MeasurableSpace Î±]

/-!
## Preliminary lemmas
-/

/-- The product of finitely many measurable ENNReal-valued functions is measurable.

This is a wrapper around `Finset.measurable_prod` specialized to ENNReal.
-/
lemma measurable_prod_ennreal {Î¹ : Type*} [Fintype Î¹] {Î© : Type*} [MeasurableSpace Î©]
    (f : Î¹ â†’ Î© â†’ ENNReal) (hf : âˆ€ i, Measurable (f i)) :
    Measurable fun Ï‰ => âˆ i, f i Ï‰ := by
  apply Finset.measurable_prod
  intro i _
  exact hf i

/-- Rewrite `Set.univ.pi B` as a setOf comprehension.

This is a convenience lemma for working with measurable rectangles in product spaces.
The two forms are definitionally equal but different proof strategies prefer different forms:
- `Set.univ.pi B` is convenient for applying `Measure.pi_pi`
- `{x | âˆ€ i, x i âˆˆ B i}` is convenient for membership reasoning
-/
lemma univ_pi_eq_setOf_forall {Î¹ : Type*} {Î± : Type*} (B : Î¹ â†’ Set Î±) :
    Set.univ.pi B = {x | âˆ€ i, x i âˆˆ B i} := by
  ext x; simp [Set.pi]

/-!
## Ï€-system structure of rectangles
-/

/-- Measurable rectangles form a Ï€-system for the product Ïƒ-algebra.

A rectangle in (Fin m â†’ Î±) is a set of the form {x | âˆ€ i, x i âˆˆ B i} where each B i
is measurable. The collection of such rectangles is closed under finite intersections.
-/
lemma rectangles_isPiSystem {m : â„•} {Î± : Type*} [MeasurableSpace Î±] :
    IsPiSystem {S : Set (Fin m â†’ Î±) | âˆƒ (B : Fin m â†’ Set Î±),
      (âˆ€ i, MeasurableSet (B i)) âˆ§ S = {x | âˆ€ i, x i âˆˆ B i}} := by
  intro Sâ‚ hSâ‚ Sâ‚‚ hSâ‚‚ _hne
  -- Sâ‚ and Sâ‚‚ are rectangles
  obtain âŸ¨Bâ‚, hBâ‚_meas, rflâŸ© := hSâ‚
  obtain âŸ¨Bâ‚‚, hBâ‚‚_meas, rflâŸ© := hSâ‚‚
  -- Their intersection is also a rectangle
  use fun i => Bâ‚ i âˆ© Bâ‚‚ i
  constructor
  Â· intro i
    exact (hBâ‚_meas i).inter (hBâ‚‚_meas i)
  Â· ext x
    simp only [Set.mem_inter_iff, Set.mem_setOf_eq]
    constructor
    Â· intro âŸ¨hâ‚, hâ‚‚âŸ© i
      exact âŸ¨hâ‚ i, hâ‚‚ iâŸ©
    Â· intro h
      exact âŸ¨fun i => (h i).1, fun i => (h i).2âŸ©

/-- The product Ïƒ-algebra on (Fin m â†’ Î±) is generated by measurable rectangles.

This is a fundamental result in product measure theory: the Ïƒ-algebra on a finite
product equals the Ïƒ-algebra generated by measurable rectangles.

Proof strategy:
- The product Ïƒ-algebra is the smallest Ïƒ-algebra making all projections measurable
- A set is in this Ïƒ-algebra iff it's in the Ïƒ-algebra generated by cylinder sets
- Cylinder sets are finite intersections of preimages of projections
- These are exactly the rectangles

In mathlib, this follows from `generateFrom_pi` which establishes the equivalence
between the product Ïƒ-algebra and the Ïƒ-algebra generated by rectangles.
-/
lemma rectangles_generate_pi_sigma {m : â„•} {Î± : Type*} [MeasurableSpace Î±] :
    (inferInstance : MeasurableSpace (Fin m â†’ Î±)) =
    MeasurableSpace.generateFrom {S : Set (Fin m â†’ Î±) | âˆƒ (B : Fin m â†’ Set Î±),
      (âˆ€ i, MeasurableSet (B i)) âˆ§ S = {x | âˆ€ i, x i âˆˆ B i}} := by
  -- The key insight: mathlib's generateFrom_pi shows that for finite index sets,
  -- the product Ïƒ-algebra equals the Ïƒ-algebra generated by measurable rectangles

  -- First establish the set equality: our rectangles match mathlib's rectangle format
  have set_eq : {S : Set (Fin m â†’ Î±) | âˆƒ (B : Fin m â†’ Set Î±),
      (âˆ€ i, MeasurableSet (B i)) âˆ§ S = {x | âˆ€ i, x i âˆˆ B i}} =
      Set.pi univ '' Set.pi univ fun i : Fin m => {s : Set Î± | MeasurableSet s} := by
    ext S
    constructor
    Â· intro âŸ¨B, hB_meas, hSâŸ©
      use fun i => B i
      simp only [Set.mem_pi]
      constructor
      Â· intro i _; exact hB_meas i
      Â· have : univ.pi (fun i => B i) = {x | âˆ€ i, x i âˆˆ B i} := by
          ext x; simp [Set.pi]
        rw [this]; exact hS.symm
    Â· intro âŸ¨B, hB_mem, hSâŸ©
      simp only [Set.mem_pi, Set.mem_univ, Set.mem_setOf_eq] at hB_mem hS
      use B
      constructor
      Â· exact fun i => hB_mem i (Set.mem_univ i)
      Â· have : univ.pi (fun i => B i) = {x | âˆ€ i, x i âˆˆ B i} := by
          ext x; simp [Set.pi]
        rw [â† this]; exact hS.symm

  rw [set_eq]
  exact generateFrom_pi.symm

/-!
## Measurability of product measure kernels
-/

/-- The product measure kernel Ï‰ â†¦ Measure.pi (fun _ => Î½ Ï‰) is measurable.

Given a measurable family of probability measures Î½ : Î© â†’ Measure Î±, the product
kernel Ï‰ â†¦ âˆáµ¢ Î½ Ï‰ (where i ranges over Fin m) is measurable as a measure-valued map.

**Proof strategy**: Use Ï€-system induction on rectangles:
1. Rectangles generate the product Ïƒ-algebra (`rectangles_generate_pi_sigma`)
2. Rectangles form a Ï€-system (`rectangles_isPiSystem`)
3. On rectangles, the product measure of {x | âˆ€ i, x i âˆˆ B i} equals âˆáµ¢ Î½ Ï‰ (B i),
   which is measurable in Ï‰ by `measurable_prod_ennreal`
4. By the Ï€-Î» theorem (`Measurable.measure_of_isPiSystem_of_isProbabilityMeasure`),
   measurability on the generating Ï€-system extends to all measurable sets

This is a key lemma for proving the ConditionallyIID property in de Finetti's theorem.

**Mathematical content**: This shows that finite products of probability kernels
yield measurable kernels, which is essential for disintegration theory and
conditional independence.
-/
lemma measurable_measure_pi {Î© Î± : Type*} [MeasurableSpace Î©] [MeasurableSpace Î±]
    {m : â„•}
    (Î½ : Î© â†’ Measure Î±) (hÎ½_prob : âˆ€ Ï‰, IsProbabilityMeasure (Î½ Ï‰))
    (hÎ½_meas : âˆ€ s, MeasurableSet s â†’ Measurable (fun Ï‰ => Î½ Ï‰ s)) :
    Measurable fun Ï‰ => Measure.pi fun _ : Fin m => Î½ Ï‰ := by
  classical
  -- Abbreviation for the product kernel
  let Îº : Î© â†’ Measure (Fin m â†’ Î±) := fun Ï‰ => Measure.pi fun _ : Fin m => Î½ Ï‰
  -- Rectangular generator and Ï€-system for the product Ïƒ-algebra
  let ğ’ : Set (Set (Fin m â†’ Î±)) :=
    {S | âˆƒ (B : Fin m â†’ Set Î±), (âˆ€ i, MeasurableSet (B i)) âˆ§
        S = {x | âˆ€ i, x i âˆˆ B i}}

  have h_gen : (inferInstance : MeasurableSpace (Fin m â†’ Î±))
      = MeasurableSpace.generateFrom ğ’ :=
    rectangles_generate_pi_sigma (m := m) (Î± := Î±)
  have h_pi : IsPiSystem ğ’ := rectangles_isPiSystem (m := m) (Î± := Î±)

  -- Values on rectangles are measurable
  have h_basic : âˆ€ t âˆˆ ğ’, Measurable fun Ï‰ => Îº Ï‰ t := by
    intro t ht
    rcases ht with âŸ¨B, hB, rflâŸ©
    have rect : (fun Ï‰ => Îº Ï‰ {x : Fin m â†’ Î± | âˆ€ i, x i âˆˆ B i})
        = fun Ï‰ => âˆ i : Fin m, Î½ Ï‰ (B i) := by
      funext Ï‰
      have : {x : Fin m â†’ Î± | âˆ€ i, x i âˆˆ B i}
          = Set.univ.pi fun i => B i := by
        ext x; simp [Set.pi]
      simp [Îº, this, Measure.pi_pi]
    have hfac : âˆ€ i, Measurable fun Ï‰ => Î½ Ï‰ (B i) := by
      intro i; exact hÎ½_meas (B i) (hB i)
    have hmeas : Measurable fun Ï‰ => âˆ i : Fin m, Î½ Ï‰ (B i) :=
      measurable_prod_ennreal (fun i Ï‰ => Î½ Ï‰ (B i)) hfac
    simpa [Îº, rect]

  -- Each product measure is a probability measure
  have hÎº_prob : âˆ€ Ï‰, IsProbabilityMeasure (Îº Ï‰) := by
    intro Ï‰
    classical
    haveI : âˆ€ _ : Fin m, IsProbabilityMeasure (Î½ Ï‰) := fun _ => hÎ½_prob Ï‰
    simp only [Îº]
    infer_instance

  -- Apply Ï€-Î» theorem to extend measurability from rectangles to all measurable sets
  exact Measurable.measure_of_isPiSystem_of_isProbabilityMeasure
    (Î¼ := Îº) (S := ğ’) h_gen h_pi h_basic

/-- AE-measurable version of `measurable_measure_pi`.

This is the version originally proved in `CommonEnding.lean`. The measurable version
`measurable_measure_pi` is stronger and generally more useful, but this AE version
is kept for compatibility.

Note: The hypothesis only requires measurability for **measurable** sets, matching
what `Kernel.measurable_coe` provides. This is the standard requirement in measure theory.
-/
lemma aemeasurable_measure_pi {Î© Î± : Type*} [MeasurableSpace Î©] [MeasurableSpace Î±]
    {Î¼ : Measure Î©} {m : â„•}
    (Î½ : Î© â†’ Measure Î±) (hÎ½_prob : âˆ€ Ï‰, IsProbabilityMeasure (Î½ Ï‰))
    (hÎ½_meas : âˆ€ s, MeasurableSet s â†’ Measurable (fun Ï‰ => Î½ Ï‰ s)) :
    AEMeasurable (fun Ï‰ => Measure.pi fun _ : Fin m => Î½ Ï‰) Î¼ := by
  -- The measurable version immediately implies AE-measurability
  have h_meas : Measurable fun Ï‰ => Measure.pi fun _ : Fin m => Î½ Ï‰ := by
    apply measurable_measure_pi Î½ hÎ½_prob
    exact hÎ½_meas
  exact h_meas.aemeasurable
